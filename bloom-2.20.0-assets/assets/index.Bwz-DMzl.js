import{rP as h,rQ as p,rR as z,rS as D,rT as R,aM as _,rU as w,rV as P,rW as v,rX as N,rY as F,rZ as y,r_ as L,r$ as j,s0 as S,s1 as C,s2 as Q,s3 as B,s4 as W,s5 as T,s6 as U,s7 as V}from"./index-B7B3_d_S.js";import{i as G}from"./is-plan-event-enabled.rA4ObCIp.js";function k(t){return t.toLowerCase().replace(".","").replace(/\s+/g,"-")}function E(t,e){return e===void 0&&(e=!1),e?btoa(t).replace(/=/g,""):void 0}function X(t){return("Integration"in t?t.Integration:t).prototype.name}function Y(t,e,i){var n,a;try{var r=((a=(n=window?.performance)===null||n===void 0?void 0:n.getEntriesByName(t,"resource"))!==null&&a!==void 0?a:[])[0];r&&e.stats.gauge("legacy_destination_time",Math.round(r.duration),_([i],r.duration<100?["cached"]:[],!0))}catch{}}function Z(t,e,i){var n;if("Integration"in t){var a={user:function(){return i.user()},addIntegration:function(){}};t(a),n=t.Integration}else n=t;var r=new n(e);return r.analytics=i,r}function $(t,e,i,n){return h(this,void 0,void 0,function(){var a,r,s,d,u,l;return p(this,function(f){switch(f.label){case 0:a=k(e),r=E(a,n),s=D(),d="".concat(s,"/integrations/").concat(r??a,"/").concat(i,"/").concat(r??a,".dynamic.js.gz"),f.label=1;case 1:return f.trys.push([1,3,,4]),[4,z(d)];case 2:return f.sent(),Y(d,t,e),[3,4];case 3:throw u=f.sent(),t.stats.gauge("legacy_destination_time",-1,["plugin:".concat(e),"failed"]),u;case 4:return l=window["".concat(a,"Deps")],[4,Promise.all(l.map(function(g){return z(s+g+".gz")}))];case 5:return f.sent(),window["".concat(a,"Loader")](),[2,window["".concat(a,"Integration")]]}})})}function H(t,e,i){return h(this,void 0,void 0,function(){var n,a,r,s;return p(this,function(d){return n=D(),a=k(t),r=E(t,i),s="".concat(n,"/integrations/").concat(r??a,"/").concat(e,"/").concat(r??a,".dynamic.js.gz"),[2,R(s)]})})}function J(t){var e,i,n,a;return(a=(i=(e=t?.versionSettings)===null||e===void 0?void 0:e.override)!==null&&i!==void 0?i:(n=t?.versionSettings)===null||n===void 0?void 0:n.version)!==null&&a!==void 0?a:"latest"}var K=function(t,e){var i,n=e.type,a=e.bundlingStatus,r=e.versionSettings,s=a!=="unbundled"&&(n==="browser"||((i=r?.componentTypes)===null||i===void 0?void 0:i.includes("browser")));return!t.startsWith("Segment")&&t!=="Iterable"&&s},q=function(t,e){var i=e.All===!1&&e[t]===void 0;return e[t]===!1||i};function x(t,e){return h(this,void 0,void 0,function(){var i,n=this;return p(this,function(a){switch(a.label){case 0:return i=[],P()?[2,e]:[4,C(function(){return e.length>0&&U()},function(){return h(n,void 0,void 0,function(){var r,s,d;return p(this,function(u){switch(u.label){case 0:return r=e.pop(),r?[4,T(r,t)]:[2];case 1:return s=u.sent(),d=s instanceof V,d||i.push(r),[2]}})})})];case 1:return a.sent(),i.map(function(r){return e.pushWithBackoff(r)}),[2,e]}})})}var ee=function(){function t(e,i,n,a,r,s){a===void 0&&(a={});var d=this;this.options={},this.type="destination",this.middleware=[],this.initializePromise=Q(),this.flushing=!1,this.name=e,this.version=i,this.settings=v({},a),this.disableAutoISOConversion=r.disableAutoISOConversion||!1,this.integrationSource=s,this.settings.type&&this.settings.type==="browser"&&delete this.settings.type,this.initializePromise.promise.then(function(u){return d._initialized=u},function(){}),this.options=r,this.buffer=r.disableClientPersistence?new B(4,[]):new W(4,"".concat(n,":dest-").concat(e)),this.scheduleFlush()}return t.prototype.isLoaded=function(){return!!this._ready},t.prototype.ready=function(){var e=this;return this.initializePromise.promise.then(function(){var i;return(i=e.onReady)!==null&&i!==void 0?i:Promise.resolve()})},t.prototype.load=function(e,i){var n;return h(this,void 0,void 0,function(){var a,r,s=this;return p(this,function(d){switch(d.label){case 0:return this._ready||this.onReady!==void 0?[2]:(n=this.integrationSource)!==null&&n!==void 0?(r=n,[3,3]):[3,1];case 1:return[4,$(e,this.name,this.version,this.options.obfuscate)];case 2:r=d.sent(),d.label=3;case 3:a=r,this.integration=Z(a,this.settings,i),this.onReady=new Promise(function(u){var l=function(){s._ready=!0,u(!0)};s.integration.once("ready",l)}),this.integration.on("initialize",function(){s.initializePromise.resolve(!0)});try{w(e,{integrationName:this.name,methodName:"initialize",type:"classic"}),this.integration.initialize()}catch(u){throw w(e,{integrationName:this.name,methodName:"initialize",type:"classic",didError:!0}),this.initializePromise.resolve(!1),u}return[2]}})})},t.prototype.unload=function(e,i){return H(this.name,this.version,this.options.obfuscate)},t.prototype.addMiddleware=function(){for(var e,i=[],n=0;n<arguments.length;n++)i[n]=arguments[n];this.middleware=(e=this.middleware).concat.apply(e,i)},t.prototype.shouldBuffer=function(e){return e.event.type!=="page"&&(P()||this._ready!==!0||this._initialized!==!0)},t.prototype.send=function(e,i,n){var a,r;return h(this,void 0,void 0,function(){var s,d,u,l,f,g;return p(this,function(c){switch(c.label){case 0:return this.shouldBuffer(e)?(this.buffer.push(e),this.scheduleFlush(),[2,e]):(s=(r=(a=this.options)===null||a===void 0?void 0:a.plan)===null||r===void 0?void 0:r.track,d=e.event.event,s&&d&&this.name!=="Segment.io"&&(u=s[d],G(s,u)?e.updateEvent("integrations",v(v({},e.event.integrations),u?.integrations)):(e.updateEvent("integrations",v(v({},e.event.integrations),{All:!1,"Segment.io":!0})),e.cancel(new N({retry:!1,reason:"Event ".concat(d," disabled for integration ").concat(this.name," in tracking plan"),type:"Dropped by plan"}))),u?.enabled&&u?.integrations[this.name]===!1&&e.cancel(new N({retry:!1,reason:"Event ".concat(d," disabled for integration ").concat(this.name," in tracking plan"),type:"Dropped by plan"}))),[4,F(this.name,e.event,this.middleware)]);case 1:if(l=c.sent(),l===null)return[2,e];f=new i(l,{traverse:!this.disableAutoISOConversion}),w(e,{integrationName:this.name,methodName:n,type:"classic"}),c.label=2;case 2:return c.trys.push([2,5,,6]),this.integration?[4,this.integration.invoke.call(this.integration,n,f)]:[3,4];case 3:c.sent(),c.label=4;case 4:return[3,6];case 5:throw g=c.sent(),w(e,{integrationName:this.name,methodName:n,type:"classic",didError:!0}),g;case 6:return[2,e]}})})},t.prototype.track=function(e){return h(this,void 0,void 0,function(){return p(this,function(i){return[2,this.send(e,y.Track,"track")]})})},t.prototype.page=function(e){var i;return h(this,void 0,void 0,function(){return p(this,function(n){switch(n.label){case 0:return!((i=this.integration)===null||i===void 0)&&i._assumesPageview&&!this._initialized&&this.integration.initialize(),[4,this.initializePromise.promise];case 1:return n.sent(),[2,this.send(e,y.Page,"page")]}})})},t.prototype.identify=function(e){return h(this,void 0,void 0,function(){return p(this,function(i){return[2,this.send(e,y.Identify,"identify")]})})},t.prototype.alias=function(e){return h(this,void 0,void 0,function(){return p(this,function(i){return[2,this.send(e,y.Alias,"alias")]})})},t.prototype.group=function(e){return h(this,void 0,void 0,function(){return p(this,function(i){return[2,this.send(e,y.Group,"group")]})})},t.prototype.scheduleFlush=function(){var e=this;this.flushing||setTimeout(function(){return h(e,void 0,void 0,function(){var i;return p(this,function(n){switch(n.label){case 0:return P()||this._ready!==!0||this._initialized!==!0?(this.scheduleFlush(),[2]):(this.flushing=!0,i=this,[4,x(this,this.buffer)]);case 1:return i.buffer=n.sent(),this.flushing=!1,this.buffer.todo>0&&this.scheduleFlush(),[2]}})})},Math.random()*5e3)},t}();function ie(t,e,i,n,a,r){var s,d;if(i===void 0&&(i={}),n===void 0&&(n={}),L())return[];e.plan&&(n=n??{},n.plan=e.plan);var u=(d=(s=e.middlewareSettings)===null||s===void 0?void 0:s.routingRules)!==null&&d!==void 0?d:[],l=e.integrations,f=n.integrations,g=j(e,n??{}),c=r?.reduce(function(o,b){var m;return v(v({},o),(m={},m[X(b)]=b,m))},{}),O=new Set(_(_([],Object.keys(l).filter(function(o){return K(o,l[o])}),!0),Object.keys(c||{}).filter(function(o){return S(l[o])||S(f?.[o])}),!0));return Array.from(O).filter(function(o){return!q(o,i)}).map(function(o){var b=l[o],m=J(b),I=new ee(o,m,t,g[o],n,c?.[o]),A=u.filter(function(M){return M.destinationName===o});return A.length>0&&a&&I.addMiddleware(a),I})}export{ee as LegacyDestination,ie as ajsDestinations};
